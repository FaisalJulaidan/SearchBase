{% extends "admin/base.html" %}

{% block title %}Answers{% endblock %}
{% block content %}
    <link href="/static/css/box.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/taggle.min.css">
    <div class="right_col" role="main">
        <div class="page-title">
            <div class="title_left">
                <h3>Answers</h3>
            </div>
        </div>
        <div class="clearfix"></div>

        <p style="font-weight: bolder;font-size: 16px;color: #de0d0d;">{{message}}</p>

        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>
                            Linking answers to your questions
                        </h2>
                        <ul class="nav navbar-right panel_toolbox">
                            <li>
                                <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                                   aria-expanded="false"><i class="fa fa-wrench"></i></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li>
                                        <a href="#">Settings 1</a>
                                    </li>
                                    <li>
                                        <a href="#">Settings 2</a>
                                    </li>
                                </ul>
                            </li>
                            <li>
                                <a class="close-link"><i class="fa fa-close"></i></a>
                            </li>
                        </ul>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <br>
                        <style media="screen">
                            .form-control {
                                border-radius: 4px;
                                width: 50%;
                                height: inherit;
                            }

                            select:not([multiple]) {
                                -webkit-appearance: none;
                                -moz-appearance: none;
                                background-position: right 50%;
                                background-repeat: no-repeat;
                                background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAMCAYAAABSgIzaAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NDZFNDEwNjlGNzFEMTFFMkJEQ0VDRTM1N0RCMzMyMkIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NDZFNDEwNkFGNzFEMTFFMkJEQ0VDRTM1N0RCMzMyMkIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo0NkU0MTA2N0Y3MUQxMUUyQkRDRUNFMzU3REIzMzIyQiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo0NkU0MTA2OEY3MUQxMUUyQkRDRUNFMzU3REIzMzIyQiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PuGsgwQAAAA5SURBVHjaYvz//z8DOYCJgUxAf42MQIzTk0D/M+KzkRGPoQSdykiKJrBGpOhgJFYTWNEIiEeAAAMAzNENEOH+do8AAAAASUVORK5CYII=);
                                padding: .5em;
                                padding-right: 1.5em;
                            }
                        </style>

                        <!-- Abdullah Hashim did below code to avoid error occured from custom.min.js file -->
                        <form id="demo-form2"></form>

                        <div class="form-group">
                            <h2>Please select a question to add answers for:</h2>
                            <div class="input-group" style="width:250px;margin:10px 0 0 10px">
                                <select name="subscription" id="question-select"
                                        class="form-control" form="signupForm" title="Note:" required
                                        style="border-radius:4px" onchange="changeQuestion()">
                                    <!-- print all questions that is classified as userInfoRetrieval -->
                                    {% for row in msg %}
                                    {% if row[0].split(";")[1] != "userInfoRetrieval" and row[0].split(";")[1] != "fileUpload" %}
                                    <option value="{{ row[0] }}">{{ row[0].split(";")[0] }}</option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <br>

                        <h2>How many answers will your question have?</h2>
                        <div class="input-group" style="width:250px;margin:10px 0 0 10px">
                            <span class="input-group-addon">Number of answers<span class="required">*</span></span>
                            <input id="number-of-answers" onchange="changeNumOfAnswers(this)" type="number" class="form-control" required placeholder="...">
                        </div>

                        <div class="ln_solid"></div>

                        <form enctype="multipart/form-data" style="text-align:center"
                              action="/admin/assistant/{{ id }}/answers" method="POST"
                              id="answersForm">

                            <div id="pasteForm">
                                <!-- Answer Forms get inserted here -->
                            </div>

                            <br>

                            <input hidden name="question" id="question_inform"></input>
                            <div class="ln_solid"></div>
                            <button class="btn btn-success">Submit</button>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block customJS %}
<script src="/static/js/taggle.js" charset="utf-8"></script>
<script>
    var extendedLogicAllowed = true;

    // show errors messages from server
    function searchToObject() {
      var pairs = window.location.search.substring(1).split("&"), obj = {}, pair,i;
      for ( i in pairs ) {
        if ( pairs[i] === "" ) continue;
        pair = pairs[i].split("=");
        obj[ decodeURIComponent( pair[0] ) ] = decodeURIComponent( pair[1] );
      } return obj;
    }
    var success = searchToObject().res
    if (success) {
        alertError('Success',(success-1)+' answers were added','success')
    }

    $("#question-select").popover({ trigger: 'hover', title: 'Note:', content: "Make sure to press submit to save data.",placement:'top',width:"200px" })

    var numberOfQuestions = 0;
    {%for item in msg %}
        numberOfQuestions++;
    {%endfor%}
    var data = createArray(numberOfQuestions);
    var i = 0;
    {%for item in msg %}
        {%for answer in item%}
            {%if answer != None %}
                data[i].push("{{answer}}");
            {%endif%}
        {%endfor%}
        i++;
    {%endfor%}
    var e = document.getElementById("question-select");
    var questionPos = e.selectedIndex;
    var squestion = e.options[e.selectedIndex].value;
    $("#question_inform").val(squestion);
    var currentNumOfAnswers = 0;
    getDatabaseData();

    function getDatabaseData() {
        currentNumOfAnswers = 0;
        for (var j = 0; j < data.length; j++) {
            var questionSelect = document.getElementById("question-select")
            if (data[j][0] == questionSelect.options[questionSelect.selectedIndex].value
            &&  data[j][0].split(";")[1] != "userInfoRetrieval") {
                var indexOfRows = 0
                var keywordsArr = []
                for (var b = 1; b < data[j].length + 1; b++) {

                    if (b == data[j].length) break

                    // if there is no answers
                    if (data[j][b] == "") break

                    var answerArr = data[j][b].split(";");
                    var pnameValue = answerArr[0]
                    var keywordValue = answerArr[1]
                    var actionValue = answerArr[2]

                    var i = (currentNumOfAnswers+1)
                    var pname = 'pname'+i
                    var keyword = 'keyword'+i
                    var action = 'action'+i

                    keywordsArr.push(keywordValue)

                    // go through infinite loop untill we add the element
                    while (true) {
                        // if there is a row
                        if ( $("#pasteForm>.row:eq("+indexOfRows+")")[0] ) {
                            var rowChildrenCount = $("#pasteForm>.row:eq("+indexOfRows+")").children().length
                            if (rowChildrenCount < 3) {
                                $("#pasteForm>.row:eq("+indexOfRows+")").append(cookUpPanel(pname,keyword,action,i,pnameValue,keywordValue,actionValue))
                                break
                            }
                            else indexOfRows++

                        } else {
                            // if there is no a row? then  add new one
                            // and add the element immediatly since it will be empty row
                            // it means no need to check if the children is less than 3
                            $("#pasteForm").append("<div class='row'></div>")
                            $("#pasteForm>.row:eq("+indexOfRows+")").append(cookUpPanel(pname,keyword,action,i,pnameValue,keywordValue,actionValue))
                            break
                        }
                    }
                    // to select the option corresponding to the record in db for the actionValue
                    $('[id=newSelect] option').filter(function () {
                        return ($(this).text() == actionValue);
                    }).prop('selected', true);
                    document.getElementById('newSelect').id = 'oldSelect';

                    currentNumOfAnswers++;
                }

                // init taggled library
                $("[id^=keyword]").each((i,element)=> {
                    var isTaggled = $(element).children()[1]
                    keywords = keywordsArr[i].split(',')
                    // if there is not keywords
                    keywords[0]? true : keywords=[]
                    console.log(keywords);
                    if (!isTaggled)
                        new Taggle(element.id, {
                            tags: keywords,
                            hiddenInputName: 'keywords'+element.id.split('keyword')[1]
                        });
                })
                $("#number-of-answers").val(currentNumOfAnswers);
            }
        }
    }

    function changeNumOfAnswers(inputEl) {
        var inputNumOfAnswers = inputEl.value
        if (inputNumOfAnswers <= 0){
            inputEl.parentElement.style.boxShadow="0 0 9px 0px #f44336"
            $(inputEl).val('');
            return alertError('Input Error','Number of answers should be greater than 0')
        }else {
            inputEl.parentElement.style.boxShadow="0 0 9px 0px rgba(100, 185, 110, 1)"
            setTimeout(function () {
                inputEl.parentElement.style.boxShadow=""
                inputEl.parentElement.style.transition="box-shadow 2s ease-in-out"
            }, 500);
            checkAnswersPanels(inputNumOfAnswers)
        }
    }
    function checkAnswersPanels(inputNumOfAnswers) {
        if (inputNumOfAnswers > currentNumOfAnswers) {
            var elements = []
            while (inputNumOfAnswers > currentNumOfAnswers) {
                var i = (currentNumOfAnswers+1)
                console.log(i);
                var pname = 'pname'+i
                var keyword = 'keyword'+i
                var action = 'action'+i

                elements.push(cookUpPanel(pname,keyword,action,i))
                currentNumOfAnswers++
            }

            var indexOfRows = 0
            for (var [index, element] of elements.entries()) {
                // go through infinite loop untill we add the element
                while (true) {
                    // if there is a row
                    if ( $("#pasteForm>.row:eq("+indexOfRows+")")[0] ) {
                        var rowChildrenCount = $("#pasteForm>.row:eq("+indexOfRows+")").children().length
                        if (rowChildrenCount < 3) {
                            $("#pasteForm>.row:eq("+indexOfRows+")").append(element)
                            break
                        }
                        else
                            indexOfRows++

                    } else {
                        // if there is no a row? then  add new one
                        // and add the element immediatly since it will be empty row
                        // it means no need to check if the children is less than 3
                        $("#pasteForm").append("<div class='row'></div>")
                        $("#pasteForm>.row:eq("+indexOfRows+")").append(element)
                        break
                    }
                }
                // init taggled library
                $("[id^=keyword]").each((i,element)=> {
                    var isTaggled = $(element).children()[1]
                    if (!isTaggled)
                        new Taggle(element.id,{
                            hiddenInputName: 'keywords'+element.id.split('keyword')[1]
                        })
                })
            }

        }
        else if (inputNumOfAnswers < currentNumOfAnswers) {
            while (inputNumOfAnswers < currentNumOfAnswers) {
                // remove panels by one panel
                var rows = $(".col-sm-4.col-xs-12")
                rows[rows.length - 1].remove();
                currentNumOfAnswers--;
            }
        }
    }
    function cookUpPanel(pname,keyword,action,i, pnameValue, keywordValue, actionValue) {
        // actions
        var options = ""
        {%for item in msg %}
            options = options + "<option value=\"Go to: " + "{{item[0]}}".split(";")[0] + "\">Go to: "+ "{{item[0]}}".split(";")[0] + "</option>"
        {% endfor %}


        // if old data available
        if (pnameValue || keywordValue)
            if (extendedLogicAllowed) {
                return "<div class=\"col-sm-4 col-xs-12\">\n" +
                    "    <div class=\"panel panel-info\">\n" +
                    "        <div class=\"panel-heading\">\n" +
                    "            <h4>Answer " + i + "</h4>\n" +
                    "        </div>\n" +
                    "        <div class=\"panel-body\">\n" +
                    "            <div class=\"input-group\">\n" +
                    "              <span class=\"input-group-addon\">Answer Text</span>\n" +
                    "              <input type=\"text\" name='" + pname + "' class=\"form-control\" placeholder=\"\" value='" + pnameValue + "'>\n" +
                    "            </div>\n" +
                    "            <div id=\"" + keyword + "\"></div>\n" +
                    "            <div class=\"input-group\">\n" +
                    "               <span class=\"input-group-addon\">Question Action</span>\n" +
                    "               <select id='newSelect' class=\"form-control\" form=\"answersForm\"  required name='" + action + "' value='" + actionValue + "'>\n" +
                    "                   <option value =\"Next Question by Order\">Next Question by Order</option>" +
                    options +
                    "                   <option value=\"Get Solutions\">Get Solutions</option>" +
                    "               </select>\n" +
                    "            </div>\n" +
                    "        </div>\n" +
                    "    </div>\n" +
                    "</div>"
            } else {
                return "<div class=\"col-sm-4 col-xs-12\">\n" +
                    "    <div class=\"panel panel-info\">\n" +
                    "        <div class=\"panel-heading\">\n" +
                    "            <h4>Answer " + i + "</h4>\n" +
                    "        </div>\n" +
                    "        <div class=\"panel-body\">\n" +
                    "            <div class=\"input-group\">\n" +
                    "              <span class=\"input-group-addon\">Answer Text</span>\n" +
                    "              <input type=\"text\" name='" + pname + "' class=\"form-control\" placeholder=\"\" value='" + pnameValue + "'>\n" +
                    "            </div>\n" +
                    "            <div id=\"" + keyword + "\"></div>\n" +
                    "            <div class=\"input-group\">\n" +
                    "               <span class=\"input-group-addon\">Question Action</span>\n" +
                    "               <select id='newSelect' class=\"form-control\" form=\"answersForm\"  required name='" + action + "' value='" + actionValue + "'>\n" +
                    "                   <option value =\"Next Question by Order\">Next Question by Order</option>" +
                    "               </select>\n" +
                    "            </div>\n" +
                    "        </div>\n" +
                    "    </div>\n" +
                    "</div>"
            }

        // if there is no old data
        else
            if (extendedLogicAllowed) {
                return "<div class=\"col-sm-4 col-xs-12\">\n" +
                    "    <div class=\"panel panel-info\">\n" +
                    "        <div class=\"panel-heading\">\n" +
                    "            <h4>Answer " + i + "</h4>\n" +
                    "        </div>\n" +
                    "        <div class=\"panel-body\">\n" +
                    "            <div class=\"input-group\">\n" +
                    "              <span class=\"input-group-addon\">Question Action</span>\n" +
                    "              <input type=\"text\" name='" + pname + "' class=\"form-control\" placeholder=\"Enter answer for the question\" required>\n" +
                    "            </div>\n" +
                    "            <div id=\"" + keyword + "\"></div>\n" +
                    "            <div class=\"input-group\">\n" +
                    "               <span class=\"input-group-addon\">Answer Text</span>\n" +
                    "               <select id='newSelect' class=\"form-control\" form=\"answersForm\"  required name='" + action + "' value='" + actionValue + "'>\n" +
                    "                   <option value =\"Next Question by Order\">Next Question by Order</option>" +
                    options +
                    "                   <option value=\"Get Solutions\">Get Solutions</option>" +
                    "               </select>\n" +
                    "            </div>\n" +
                    "        </div>\n" +
                    "    </div>\n" +
                    "</div>"
            } else {
                return "<div class=\"col-sm-4 col-xs-12\">\n" +
                    "    <div class=\"panel panel-info\">\n" +
                    "        <div class=\"panel-heading\">\n" +
                    "            <h4>Answer " + i + "</h4>\n" +
                    "        </div>\n" +
                    "        <div class=\"panel-body\">\n" +
                    "            <div class=\"input-group\">\n" +
                    "              <span class=\"input-group-addon\">Question Action</span>\n" +
                    "              <input type=\"text\" name='" + pname + "' class=\"form-control\" placeholder=\"Enter answer for the question\" required>\n" +
                    "            </div>\n" +
                    "            <div id=\"" + keyword + "\"></div>\n" +
                    "            <div class=\"input-group\">\n" +
                    "               <span class=\"input-group-addon\">Answer Text</span>\n" +
                    "               <select id='newSelect' class=\"form-control\" form=\"answersForm\"  required name='" + action + "' value='" + actionValue + "'>\n" +
                    "                   <option value =\"Next Question by Order\">Next Question by Order</option>" +
                    "               </select>\n" +
                    "            </div>\n" +
                    "        </div>\n" +
                    "    </div>\n" +
                    "</div>"
            }
    }

    function createArray(rows) {
        var arrayRow = [];
        for (var i = 0; i < rows; i++) {
            arrayRow[i] = [];
        }
        return arrayRow;
    }

    var lastQuestion = document.getElementById("question-select").value;

    function changeQuestion() {
        var e = document.getElementById("question-select");
        var questionPos = e.selectedIndex;
        var squestion = e.options[e.selectedIndex].value;
        if (lastQuestion != squestion) {
            console.log(lastQuestion + " --- " + squestion);
            $("#question_inform").val(squestion);
            $("#pasteForm").empty();
            lastQuestion = squestion;
            getDatabaseData();
        }
        changeNumOfAnswers(e);
    }

    // Hide Extended Logic depending on user Plan
    params = "";
    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/admin/getadminpagesdata", true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhttp.onreadystatechange = function () {
        if (xhttp.readyState === 4) {
            if (xhttp.status === 200) {
                var responseString = xhttp.responseText

                //get user's plan restrictions
                restrictions = responseString.split("&&&")[2];
                if (restrictions.includes("ExtendedLogic:False")) {
                    extendedLogicAllowed = false;
                }
                //ACTIVATE THE PAGE
            }
            else {
                console.error(xhttp.statusText);
            }
        }
    };
    xhttp.send(params);

</script>
{% endblock %}
