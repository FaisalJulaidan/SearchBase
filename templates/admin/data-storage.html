{% extends "admin/base.html" %}

{% block title %}Data Storage{% endblock %}

{% block headlinks %}
<!--<link rel="stylesheet" href="https://jqueryui.com/code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" href="https://jqueryui.com/resources/demos/style.css">-->
<style>
    a.tds {
        position: relative;
    }

    a.tds span {
        display: none;
        box-shadow: 1px 1px 5px grey;
        width: 170px;
    }

    a.tds:hover span {
        padding: 5px 20px 5px 5px;
        display: block;
        z-index: 100;
        background: url(../images/status-info.png) #f0f0f0 no-repeat 100% 5%;
        left: 0px;
        margin: 10px;
        position: absolute;
        top: 10px;
        text-decoration: none;
        border-radius:5px;
    }

    #tableSort{
      overflow-y:scroll;
      height:1000px;
      display:block;
    }
</style>
{%endblock%}

{% block content %}
<div class="right_col" role="main">

    <div class="x_content">

        <p>All of the Data Collected</p>

        <button onclick="fnExcelReport()" class="btn btn-success">Export Excel</button><a href="/admin/assistant/{{assistantID}}/deleteAll" class="btn btn-success">Delete All</a>
        <br />
        Note: You can click the column heading to sort it.
        <div id="tBodyUIn"></div>

    </div>
</div>
{% endblock %}

{% block customJS %}
<script src="/static/js/sortTable.js"></script>
<!--<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>-->
<script>
    //$(function () {
    //    $(document).tooltip();
    //});
    //$('#tBodyUIn').qtip({
    //    content: {
    //        text: 'Tips plugin element'
    //    }
    //})

    var currentLength = 0;
    var maxLength = 0;
    var tableString = "";
    console.log("{{data}}")
    {%if not data %}
    $("#tBodyUIn").append("<h4>All of the data collected from the bot convorsations will be stored here.</h4>");
    {%endif%}

    {%for record in data %}
        currentLength = 0;
        {%for value in record['data']['collectedInformation'] %}
            currentLength++;
        {% endfor %}
        if (currentLength > maxLength) { maxLength = currentLength; }
    {%endfor%}

    var headings = "";
    for (var i = 0; i < maxLength; i++) {
        headings += "<th style=\"cursor: pointer;\" onclick=\"sortTable(0)\" class=\"column-title\">Input "+(i+2)+"</th>";
    }

    tableString = "<table id=\"tableSort\" class=\"table\" cellspacing=\"0\" width=\"100 %\"><thead>\
                            <tr id=\"tableHeadingUIn\" class=\"headings\"><th class=\"column-title\">Action</th>\
                            <th style=\"cursor: pointer;\" onclick=\"sortTable(1)\" class=\"column-title\">Date and Time</th>"+ headings +"</tr></thead>\
                            <tbody id=\"tBodyUIn\">";
    var filename = undefined;
    {%for record in data %}
        tableString += "<tr id='tableRecord{{record['id']}}'>"
        tableString += "<td><a type='button' style='cursor: pointer;' onclick='deleteRecord({{record['id']}})'>Delete</a></td>"
        tableString += "<td>"+"{{record['dateTime']}}".split(".")[0]+"</td>"
        {%for value in record['data']['collectedInformation'] %}
            {%if '&FILE_UPLOAD&' in value['input'] %}
                filename = "{{record['filePath']}}";
                tableString += "<td><a class=\"tds\" title=\"\" href=\"/static"+"{{route}}".split("static")[1]+"/" + filename + "\" download=\"" + filename + "\">" + filename + "<span>{{value['questionText']}}</span></a></td>"
            {%else%}
                tableString += "<td><a class=\"tds\">{{value['input']}}<span>{{value['questionText']}}</span></a></td>"
            {%endif%}
        {% endfor %}
        tableString += "</tr>"
    {% endfor %}

    tableString += "</tbody></table>";
    $("#tBodyUIn").append(tableString);

    sortTable(1);

    function fnExcelReport() {
        tab_text = tableString;
        tab_text = tab_text.replace(/<A[^>]*>|<\/A>/g, "");//comment if you want links in the table
        tab_text = tab_text.replace(/<img[^>]*>/gi, ""); // comment if you want images in the table
        tab_text = tab_text.replace(/<input[^>]*>|<\/input>/gi, ""); // comment if you want input params

        var ua = window.navigator.userAgent;
        var msie = ua.indexOf("MSIE ");

        if (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./))      // If Internet Explorer
        {
            txtArea1.document.open("txt/html", "replace");
            txtArea1.document.write(tab_text);
            txtArea1.document.close();
            txtArea1.focus();
            sa = txtArea1.document.execCommand("SaveAs", true, "Say Thanks to Sumit.xls");
        }
        else                 //other browser not tested on IE 11
            sa = window.open('data:application/vnd.ms-excel,' + encodeURIComponent(tab_text));

        return (sa);
    }

    function deleteRecord(recordID) {
        $("#tableRecord" + recordID).children().last().text('...');
        $.ajax({
            url: '/admin/assistant/{{assistantID}}/'+recordID+'/delete',
            type: "GET"
        }).done(function (res) {
            if (res === "True") {
                console.log("Record deleted");
                $("#tableRecord" + recordID).remove();
            }
        }).fail(function (res) {
            console.log("Error in deleting record.");
            console.log(res);
            $("#tableRecord" + recordID).children().last().text('Delete');
            alertError('Error', 'Error in deleting record')
        });
    }
</script>
{% endblock %}
