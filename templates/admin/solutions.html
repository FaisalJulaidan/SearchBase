{% extends "admin/base.html" %}

{% block title %}Products{% endblock %}

{% block content %}
    <div class="right_col" role="main">
        <div class="">
            <div class="page-title">
                <div class="title_left">
                    <h3>Adding New Products</h3>
                </div>
            </div>
            <div class="clearfix"></div>

            <div class="row">
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="clearfix"></div>
                <div class="row">
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        <div class="x_panel">
                            <div class="x_content">
                                <p class="text-muted font-13 m-b-30">
                                    Database 1 - All of the products thats your bot scans for are listed below.
                                </p>

                                <!-- Start of welcome message -->
                                <div class="row">
                                    <div class="col-md-12 col-sm-12 col-xs-12">
                                        <div class="x_panel">
                                            <div class="x_title">
                                                <h2>Upload an existing database that you have
                                                    <small>File Types: XML, JSON (coming soon)</small>
                                                </h2>
                                                <ul class="nav navbar-right panel_toolbox"></ul>
                                                <div class="clearfix"></div>
                                            </div>
                                            <div class="x_content">
                                                <br/>
                                                <form id="productFileForm" name="productFileForm"
                                                      enctype="multipart/form-data">

                                                    <div class="form-group">
                                                        <label class="control-label col-md-3 col-sm-3 col-xs-12"
                                                               for="">
                                                            Upload your existing database for an automatic scan <span
                                                                class="required">*</span>
                                                        </label>
                                                        <br/>
                                                        <br/>
                                                        <div>
                                                            <label for="productFile">Choose file to
                                                                upload</label><br>
                                                            <input type="file" id="productFile" name="productFile">
                                                        </div>
                                                        <br/>
                                                        <button id="uploadButton" class="btn btn-success"
                                                                type="button" value="submit" onclick="uploadProductFile()">
                                                            Upload Database
                                                        </button>
                                                </form>

                                                <table class="table" id="tableExample"></table>
                                            </div>
                                        </div>
                                    </div>

                                    <form action="/admin/assistant/{{ id }}/solutions" method="post" enctype="multipart/form-data">
                                        <table id="datatable" class="table table-striped table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Delete</th>
                                                    <th>ID</th>
                                                    <th>Major Title</th>
                                                    <th>Secondary Title</th>
                                                    <th>Short Description</th>
                                                    <th>Money</th>
                                                    <th>Keywords</th>
                                                    <th>URL</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tbody">
                                            <!-- Row get inserted here -->
                                            </tbody>
                                        </table>
                                        <button type="submit" class="btn btn-success" value="Send">
                                            Save Updates
                                        </button>
                                        <button type="button" class="btn btn-success" id="addRow" value="Send" onclick="AddRow()">
                                            Add Row
                                        </button>
                                        <button type="button" class="btn btn-success" id="removeRow" value="Send" onclick="RemoveRow()">
                                            Delete Row
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Abdullah Hashim did below code to avoid error occured from custom.min.js file -->
    <form id="demo-form2"></form>
{% endblock %}

{% block customJS %}
<script>
    // TODO:
    // 1- validate the inputs that satisfies the validatitons (done)
    // 2- when delete button is clicked, delete the row no need to save Updates (done)

    // data parsing
    var numberOfProducts = 0;
    console.log("{{data}}")
    {%for item in data%}
        numberOfProducts++;
    {%endfor%}

    var data = createArray(numberOfProducts);
    var i = 0;

    {%for item in data%}
        //{%for product in item%}
        //    {%if product != None%}
        //        data[i].push("{{product}}");
        //    {%endif%}
        //{%endfor%}
        data[i] = ['{{item["ID"]}}', '{{item["SolutionID"]}}', '{{item["MajorTitle"]}}', '{{item["SecondaryTitle"]}}',
            '{{item["ShortDescription"]}}', '{{item["Money"]}}', '{{item["Keywords"]}}', '{{item["URL"]}}']
        i++;
    {%endfor%}

    // first time rendering
    i = 0;
    for (var c = 0; c < data.length; c++) {
        i++;
        $("#tbody").append("<tr id=\"tr" + String(i) + "\">\
        <td><input id=\"cb" + String(i) + "\" style=\"width: 30px;\" type=\"checkbox\" name=\"product_Delete" + String(i) + "\"></td>\
        <td><input required value=\"" + data[c][0] + "\" style=\"width: 50px;\" padding=\"3px\" margin=\"3px\" type=\"text\" name=\"product_ID" + String(i) + "\"></td>\
        <td><input required value=\"" + data[c][1] + "\" style=\"width: 90px;\" type=\"text\" name=\"product_Name" + String(i) + "\" onchange='validateName(this)'></td>\
        <td><input required value=\"" + data[c][2] + "\" style=\"width: 90px;\" type=\"text\" name=\"product_Brand" + String(i) + "\" onchange='validate(this)'></td>\
        <td><input required value=\"" + data[c][3] + "\" style=\"width: 90px;\" type=\"text\" name=\"product_Model" + String(i) + "\" onchange='validate(this)'></td>\
        <td><input required value=\"" + data[c][4] + "\" style=\"width: 60px;\" type=\"text\" name=\"product_Discount" + String(i) + "\" onchange='validate(this)'></td>\
        <td><input required value=\"" + data[c][5] + "\" style=\"width: 60px;\" type=\"text\" name=\"product_Price" + String(i) + "\" onchange='validate(this)'></td>\
        <td><input required value=\"" + data[c][6] + "\" style=\"width: 250px;\" type=\"text\" name=\"product_Keywords" + String(i) + "\" onchange='validate(this)'></td>\
        <td><input required value=\"" + data[c][7] + "\" style=\"width: 200px;\" type=\"text\" name=\"product_URL" + String(i) + "\" onchange='validate(this)'></td>\
        </tr>");
    }

    // events Listeners Functions
    //document.getElementById("addRow").addEventListener("click", AddRow);
    function AddRow() {
        console.log("adding row");
        i++;
        $("#tbody").append("<tr id=\"tr" + String(i) + "\">\
        <td><input id=\"cb" + String(i) + "\" style=\"width: 30px;\" type=\"checkbox\" name=\"product_Delete" + String(i) + "\"></td>\
        <td><input required style=\"width: 50px;\" padding=\"3px\" margin=\"3px\" type=\"text\" name=\"product_ID" + String(i) + "\"></td>\
        <td><input required style=\"width: 90px;\" type=\"text\" name=\"product_Name" + String(i) + "\" onchange='validate(this)'></td>\
        <td><input required style=\"width: 90px;\" type=\"text\" name=\"product_Brand" + String(i) + "\" onchange='validate(this)' ></td>\
        <td><input required style=\"width: 90px;\" type=\"text\" name=\"product_Model" + String(i) + "\" onchange='validate(this)' ></td>\
        <td><input required style=\"width: 60px;\" type=\"text\" name=\"product_Discount" + String(i) + "\" onchange='validate(this)' ></td>\
        <td><input required style=\"width: 60px;\" type=\"text\" name=\"product_Price" + String(i) + "\" onchange='validate(this)' ></td>\
        <td><input required style=\"width: 250px;\" type=\"text\" name=\"product_Keywords" + String(i) + "\" onchange='validate(this)' ></td>\
        <td><input required style=\"width: 200px;\" type=\"text\" name=\"product_URL" + String(i) + "\" onchange='validate(this)' ></td>\
        </tr>");
    }
    function validate(element) {
        var elName = element.name
        if ((elName).includes('product_Name')) {
            var name = element.value
            if (name.length < 2)
                noPass(element,'Data1 should be more than 2 letters')
            else
                pass(element)
        }
        else if ((elName).includes('product_Brand')) {
            var brand = element.value
            if (brand.length < 2)
                noPass(element,'Data2 should be more than 2 letters')
            else
                pass(element)
        }
        else if ((elName).includes('product_Model')) {
            var model = element.value
            if (model.length < 2)
                noPass(element,'Data3 should be more than 2 letters')
            else
                pass(element)
        }
        else if ((elName).includes('product_Price')) {
            var price = element.value
            // if there are more currencies we need to add it to the regex string
            var regex =/^[$£€][\d\.,]+/

            if (regex.test(price))
                pass(element)
            else
                noPass(element,'<h3>Price should be in this format <b>[currency][numbers]</b></h3> <br> <h4> Where the approved currencies are ($, £, and €) </h4> <br> <h5> E.g: <code>$3200.50    -    £250,000.50 - €4,000</code></h5>')
        }
        else if ((elName).includes('product_Keywords')) {
            // TODO:
            var keywords = element.value
        }
        else if ((elName).includes('product_Discount')) {
            // TODO:
            var discount = element.value
        }
        else if ((elName).includes('product_URL')) {
            var userURL = element.value
            var URLRegex = /^((https?|ftp|smtp):\/\/)?(www.)?[a-z0-9]+(\.[a-z]{2,}){1,3}(#?\/?[a-zA-Z0-9#]+)*\/?(\?[a-zA-Z0-9-_]+=[a-zA-Z0-9-%]+&?)?$/;

            if (userURL.match(URLRegex))
                pass(element)
            else
                noPass(element,"Please enter your website URL correctly.")
        }

        // helping function
        function pass(element) {
            element.style.boxShadow="0 0 9px 0px rgba(100, 185, 110, 1)"
            setTimeout(function () {
                element.style.boxShadow=""
                element.style.transition="box-shadow 1s ease-in-out"
            }, 500);
        }
        function noPass(element,text) {
            element.style.boxShadow="0 0 9px 0px #f44336"
            alertError('Input Error',text)
        }
    }

    //document.getElementById("removeRow").addEventListener("click", RemoveRow);
    function RemoveRow() {
        var confirmDelete = confirm('Are you sure you want to delete this row?')
        if (confirmDelete) {
            for (var c = 1; c <= i; c++) {
                try {
                    if (document.getElementById("cb" + String(c)).checked) {
                        document.getElementById("tr" + String(c)).remove();
                        c--;
                        for (var v = c; v <= i; v++) {
                            document.getElementsByName("product_Delete" + String(v + 1))[0].setAttribute("name", "product_Delete" + String(v));
                            document.getElementsByName("product_ID" + String(v + 1))[0].setAttribute("name", "product_ID" + String(v));
                            document.getElementsByName("product_Name" + String(v + 1))[0].setAttribute("name", "product_Name" + String(v));
                            document.getElementsByName("product_Brand" + String(v + 1))[0].setAttribute("name", "product_Brand" + String(v));
                            document.getElementsByName("product_Model" + String(v + 1))[0].setAttribute("name", "product_Model" + String(v));
                            document.getElementsByName("product_Discount" + String(v + 1))[0].setAttribute("name", "product_Discount" + String(v));
                            document.getElementsByName("product_Price" + String(v + 1))[0].setAttribute("name", "product_Price" + String(v));
                            document.getElementsByName("product_Keywords" + String(v + 1))[0].setAttribute("name", "product_Keywords" + String(v));
                            document.getElementsByName("product_URL" + String(v + 1))[0].setAttribute("name", "product_URL" + String(v));
                            i--;
                        }
                    }
                }
                catch (exx) {
                    // console.log("Skip " + String(c));
                    console.log(exx);
                }
            }
            $("form>button[type=submit]").click()
        }
    }

    //document.getElementById('uploadButton').addEventListener('click',uploadProductFile)
    function uploadProductFile() {
        // TODO: validate the type of product before update
        // 1- if submit without adding file (done)
        // 2- submit with a wroung dataType (done)
        // 3- if there is backend response show it
        if ($("#productFile").val()) {
            if ($("#productFile").val().includes('json')
            ||  $("#productFile").val().includes('xml') ) {
                var form = document.forms.namedItem("productFileForm");
                formData = new FormData(form);
                var xhttp = new XMLHttpRequest();
                var msg = "";
                xhttp.open("POST", "/admin/assistant/{{ id }}/solutions/file", true); // true is asynchronous
                xhttp.onreadystatechange = function () {
                    if (xhttp.readyState === 4) {
                        if (xhttp.status === 200) {
                            msg = xhttp.responseText;
                            window.location.reload();
                        }
                        else {
                            console.error(xhttp.statusText);
                            msg = "Error: " + xhttp.status;
                        }
                        console.log(msg);
                    }
                };
                xhttp.send(formData);
                return false;
            }
            else
                alertError('Upload File Error','<h2>Data Type must be <b>json</b> or <b>xml</b></h2>')
        }
        else
            alertError('Upload File Error','<h2>There is no file to upload</h2>')
    }


    // helping functions
    function createArray(rows) {
        var arrayRow = [];
        for (var i = 0; i < rows; i++) {
            arrayRow[i] = [];
        }
        return arrayRow;
    }

    // Hide Extended Logic depending on user Plan
    params = "";
    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/admin/getadminpagesdata", true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhttp.onreadystatechange = function () {
        if (xhttp.readyState === 4) {
            if (xhttp.status === 200) {
                var responseString = xhttp.responseText

                //get user's plan restrictions
                restrictions = responseString.split("&&&")[2];
                if (restrictions.includes("ImportDatabase:False")) {
                    $("#productFileForm").hide();
                }
                //ACTIVATE THE PAGE
            }
            else {
                console.error(xhttp.statusText);
            }
        }
    };
    xhttp.send(params);

</script>
{% endblock %}
