{% extends "admin/base.html" %}

{% block title %}Pay Page{% endblock %}


{% block content %}


<link rel="stylesheet" type="text/css" href="../../static/pay/css/base.css" data-rel-css="">

<link rel="stylesheet" type="text/css" href="../../static/stripe/style.css" data-rel-css="">

<!-- Stripe -->
<script src="https://js.stripe.com/v3/"></script>



<div class="right_col" role="main" style="margin-top:0">

    <div class="page-title">
      <div class="title_left">
        <h3>Enter your payment details</h3>
      </div>
    </div>

    <div class="clearfix"></div>

    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>
                        This is the last step to finish your payment
                        <small>
                            Tip: Check all of your data is correct.
                        </small>
                    </h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <main>

                      <div class="form-row">
                        <label for="card-element" style="font-size: 15px; font-weight: 200">
                          Credit/Debit Card:
                        </label>
                        <div id="card-element">
                          <!-- A Stripe Element will be inserted here. -->
                        </div>

                        <!-- Used to display form errors. -->
                        <div id="card-errors" role="alert"></div>
                      </div>

                        <br>


                      <div class="input-group">
                          <span class="input-group-addon">Promo Code</span>
                          <input type="text" class="form-control" id="promo-code" style="border-style:solid">
                      </div>



                      <button id="stripe_button">Submit Payment {{ plan['amount']/100 }} GBP</button>

                    </main>
                    <br>
                    <br>
                    <br>
                    <br>
                </div>
            </div>
        </div>
    </div>





</div>
{% endblock %}

{% block customJS %}
<!-- SweetAlert Library -->
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="../../static/stripe/script.js" data-rel-js></script>

<script type="text/javascript">


    if (sessionStorage.getItem('subID') != 'null'){
      swal({
          title: "Are you sure?",
          text: "You will lose your active subscription.",
          icon: "warning",
          buttons: true,
          dangerMode: true,
      }).then((willDelete) => {
        if (willDelete) {

        } else {
        document.location.href = '/admin/pricing'
        }
        });
    }



// Create a Stripe client.
var stripe = Stripe('pk_test_e4Tq89P7ma1K8dAjdjQbGHmR');

// Create an instance of Elements.
var elements = stripe.elements();

// Custom styling can be passed to options when creating an Element.
// (Note that this demo uses a wider set of styles than the guide below.)
var style = {
  base: {
    color: '#32325d',
    lineHeight: '18px',
    fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
    fontSmoothing: 'antialiased',
    fontSize: '16px',
    '::placeholder': {
      color: '#aab7c4'
    }
  },
  invalid: {
    color: '#fa755a',
    iconColor: '#fa755a'
  }
};

// Create an instance of the card Element.
var card = elements.create('card', {style: style});

// Add an instance of the card Element into the `card-element` <div>.
card.mount('#card-element');

// Handle real-time validation errors from the card Element.
card.addEventListener('change', function(event) {
  var displayError = document.getElementById('card-errors');
  if (event.error) {
    displayError.textContent = event.error.message;
  } else {
    displayError.textContent = '';
  }
});

// Handle form submission.
var form = document.getElementById('stripe_button');
form.addEventListener('click', function(event) {
  event.preventDefault();
  event.stopImmediatePropagation();

  stripe.createToken(card).then(function(result) {
      cosole.log(result);
    if (result.error) {
      // Inform the user if there was an error.
      var errorElement = document.getElementById('card-errors');
      errorElement.textContent = result.error.message;
    } else {
      // Send the token to your server.
      stripeTokenHandler(result.token);
    }
  });
});


function stripeTokenHandler(token) {
        console.log(token)
      $.post({
        url: '/admin/subscribe/' + {{plan['id']}},
        contentType: 'application/json',
        data: JSON.stringify({
            token: token,
            coupon: $(document.getElementById('promo-code')).val()
        }),
        success: (res) => {
            if (res.error){
                swal("Ooops!", res.error, "error");
            } else {

                swal({
                  title: "Successful Payment",
                  text: res.success,
                  icon: "success",
                });

            }
        }
      });


}


</script>
{% endblock %}
