<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- The above 4 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <!-- Title -->
    <title>Bot</title>

    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#884BDF">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#884BDF">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-status-bar-style" content="#884BDF">

    <!-- Icon images -->
    <link rel="apple-touch-icon" sizes="57x57" href="/static/img/core-img/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/static/img/core-img/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/static/img/core-img/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/static/img/core-img/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/static/img/core-img/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/static/img/core-img/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/static/img/core-img/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/img/core-img/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/img/core-img/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/img/core-img/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/img/core-img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/static/img/core-img/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/img/core-img/favicon-16x16.png">
    <link rel="manifest" href="/static/img/core-img/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/static/img/core-img/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <!-- Pop-up Stylesheet -->
    <!-- <link href="/static/pop-up/pop.css" rel="stylesheet"> -->

    <!-- Responsive CSS -->
    <link href="/static/css/responsive.css" rel="stylesheet">

    <!-- Core Stylesheet -->
    <!-- <link href="/static/css/style.css" rel="stylesheet"> -->
    <!-- <link href="/static/css/main.css" rel="stylesheet"> -->

    <!-- Responsive CSS -->
    <link href="/static/css/responsive.css" rel="stylesheet">
    <!-- Jquery-2.2.4 JS -->
    <script src="/static/js/jquery-2.2.4.min.js"></script>
    <!-- Popper js -->
    <script src="/static/js/popper.min.js"></script>
    <!-- Bootstrap-4 Beta JS -->
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- All Plugins JS -->
    <script src="/static/js/plugins.js"></script>
    <!-- Slick Slider Js-->
    <script src="/static/js/slick.min.js"></script>
    <!-- Footer Reveal JS -->
    <script src="/static/js/footer-reveal.min.js"></script>
    <!-- Active JS -->
    <!-- <script src="/static/js/active.js"></script> -->

    <!-- Emoji JS and CSS -->
    <script src="https://cdn.jsdelivr.net/npm/emojione@3.1.4/lib/js/emojione.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emojione@3.1.4/extras/css/emojione.min.css" />


    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <!--already imported in client's page-->
    <!--<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>-->


    <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css'>
    <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css'>
</head>

<style>
    html,
    body {
        width: 100% !important;
        height: 100% !important;
    }

    body {
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "proxima-nova", "Source Sans Pro", sans-serif;
        font-size: 1em;
        letter-spacing: 0.1px;
        color: #32465a;
        text-rendering: optimizeLegibility;
        text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.004);
        -webkit-font-smoothing: antialiased;
    }

    #frame {
        width: 100%;
        height: 100%;
        background: #E6EAEA;
            {
            #border-radius: 5px;
            #
        }
    }

    #frame .content {
        float: right;
        width: 100%;
        height: 100%;
        overflow: hidden;
        position: relative;
    }

    #frame .content .contact-profile {
        width: 100%;
        height: 60px;
        line-height: 60px;
        background: #f5f5f5;
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
    }

    #frame .content .contact-profile img {
        width: 40px;
        border-radius: 50%;
        float: left;
        margin: 9px 12px 0 9px;
        padding: 5px;
    }

    #frame .content .contact-profile p {
        float: left;
    }

    #frame .content .contact-profile .social-media {
        float: right;
    }

    #frame .content .contact-profile .social-media i {
        margin-left: 14px;
        cursor: pointer;
    }

    #frame .content .contact-profile .social-media i:nth-last-child(1) {
        margin-right: 20px;
    }

    #frame .content .contact-profile .social-media i:hover {
        color: #435f7a;
    }

    #frame .content .messages {
        overflow-y: scroll;
        position: absolute;
        /* width: 100%; */
        top: 0;
        left: 0;
        bottom: 0;
        overflow-x: hidden;
        right: -17px;
    }

    #frame .content .messages::-webkit-scrollbar {
        width: 8px;
        background: transparent;
    }

    #frame .content .messages::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.3);
    }

    #frame .content .messages ul li {
        display: inline-block;
        clear: both;
        float: left;
        margin: 15px 15px 5px 15px;
        width: calc(100% - 25px);
        font-size: 0.9em;
    }

    #frame .content .messages ul li:nth-last-child(1) {
        margin-bottom: 20px;
    }

    #frame .content .messages ul li.sent img {
        float: right;
        margin: 6px 8px 0 0;
    }

    #frame .content .messages ul li.sent p {
        margin-right: 5px;
        background: #435f7a;
        color: #f5f5f5;
        float: right;
    }

    #frame .content .messages ul li.replies img {
        margin: 6px 0 0 8px;
    }

    #frame .content .messages ul li.replies p {
        background: #f5f5f5;
        margin-left: 5px;
    }

    #frame .content .messages ul li img {
        width: 22px;
        border-radius: 50%;
        float: left;
    }

    #frame .content .messages ul li p {
        display: inline-block;
        padding: 10px 15px;
        border-radius: 20px;
        max-width: 205px;
        line-height: 130%;
    }

    #frame .content .message-input {
        position: absolute;
        bottom: 0;
        width: 100%;
        z-index: 99;
        height: 55px;
    }

    #frame .content .message-input .wrap {
        position: relative;
    }

    #frame .content .message-input .wrap input {
        font-family: "proxima-nova", "Source Sans Pro", sans-serif;
        float: left;
        border: none;
        width: calc(100% - 50px);
        height: 40px;
        padding: 11px 32px 10px 12px;
        font-size: 0.8em;
        color: #32465a;
    }

    @media screen and (max-width: 735px) {
        #frame .content .message-input .wrap input {
            padding: 11px 32px 10px 12px;
        }
    }

    #frame .content .message-input .wrap input:focus {
        outline: none;
    }

    #frame .content .message-input .wrap button {
        float: right;
        border: none;
        width: 50px;
        /*height: 40px;*/
        padding: 12px 0;
        cursor: pointer;
        background: #32465a;
        color: #f5f5f5;
    }

    #frame .content .message-input .wrap button:hover {
        background: #435f7a;
    }

    #frame .content .message-input .wrap button:focus {
        outline: none;
    }

    #frame .content .message-input .wrap button.answer {
        float: inherit;
        margin-left: 20px;
        margin-right: 20px;
        padding: 10px;
        width: auto;
    }

    @media screen and (max-width: 735px) {
        #frame .content .message-input .wrap button.answer {
            margin-left: 5px;
            margin-right: 5px;
            padding: 10px;
            width: auto;
        }
    }

    #frame .content .message-input .wrap button.answer:focus {
        outline: none;
    }

    .endChat {
        display: inline-block;
        padding: 10px 15px;
        border-radius: 20px;
        max-width: 205px;
        line-height: 130%;
        background-color: #BA68C8;
        float: left;
        color: white;
        cursor: pointer;
        margin-left: 5px;
    }

    .results {
        display: inline-block;
        padding: 10px 15px;
        border-radius: 20px;
        max-width: 205px;
        line-height: 130%;
        background: #f5f5f5;
    }

    .answerOptions {
        color: black;
        padding: 5px 11px;
        border: 1px solid #ddd;
        border-radius: 500px;
        margin: 5px;
        background-color: #eeeeee;
        text-align: center;
    }

    .answerOptions:hover {
        color: #ffffff;
        background: grey;
        cursor: pointer;
    }

    #thinkingGif {
        /*background: white;
        width: 10px;*/
        margin-top: 45px;
    }

    #thinkingGifIMG {
        width: 72px;
    }



    .replies {
      margin-top: 40px;
    }
    /* {# @media screen and (max-width: 735px) {#}
    {#    #frame .content {#}
    {#        width: 100%;#}
    {#        min-width: 250px !important;#}
    {#    }
    {##}
    {#    #frame .content .messages {#}
    {#        max-height: calc(100% - 115px);#}
    {#    }
    {##}
    {#    #frame .content .messages ul li p {#}
    {#        max-width: 300px;#}
    {#    }
    {##}
    {#    #frame .content .message-input .wrap input {#}
    {#        padding: 11px 32px 10px 12px;#}
    {#    }
    {##}
    {#   #frame .content .message-input .wrap button.answer {#}
    {#        margin-left: 5px;#}
    {#        margin-right: 5px;#}
    {#        padding: 10px;#}
    {#        width: auto;#}
    {#    }
    {#}
    {##}
    {#@media screen and (min-width: 900px) {#}
    {#    #frame .content {#}
    {#        width: 100%;#}
    {#    }
    {#} */
</style>

<body id="chatbotBody">
    <div id="frame">
        <div class="content">
            <div class="messages">
                <ul></ul>
                <div id="presetAnswers"></div>
                <div id="chatBottom"></div>
            </div>

            <div class="message-input" id="message-input">
                <form id="fileUploadForm" action="/" method="get" class="image-upload" style="display:none" onsubmit="return sendFileForm();">
                    <div class="wrap" style="margin-top: 15px;min-height: 40px; background-color: white;">
                        <label style="background-color: white;width: 10%;float:left" for="fileUploadB">
                            <i style="font-size: 30px;margin: 6px 0px 0px 10px;" class="fa fa-paperclip"></i>
                        </label>
                        <input hidden name="file" onkeypress="handleEnter(event)" id="fileUploadB" type="file" style="background-color: white;" onchange="fileUploadNameUpdate()"/>
                        <button type="button" onclick="submitAnswer('')" class="submit">
                            <i class="fa fa-paper-plane" aria-hidden="true"></i>
                        </button>
                        <input onkeypress="handleEnter(event)" autocomplete="off" style="width:79%" id="displayFileName" type="text" placeholder="Upload your file..."/>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- <script src="/static/chatbot/script.js"></script> -->
    <script>
        var assistant = null;
        var blocks = []; // Blocks ordered
        var currentBlock = undefined;
        var keywords = [];
        var cancelScroll = false;
        var collectedInformation = [];
        var fileUpload = false;
        var params = undefined;
        var sessionID = 0;
        var welcomeMessage = "";
        var BOT_USER = 'bot';
        var CLIENT_USER = 'user';
        var chatInputDiv = document.getElementById("message-input");
        var fileUploadForm = document.getElementById('fileUploadForm');
        var thinkingGifLife = 800 + Math.floor(Math.random() * 1200);
        var sentOnClose = false;

        window.onbeforeunload = function () { sendOnCloseData(); }

        function sendOnCloseData() {
            if (!sentOnClose && collectedInformation.length != 0) { sendData(); sentOnClose = true; }
        }

        function fileUploadNameUpdate() {
            $("#displayFileName").val($("#fileUploadB").val());
        }

        // This function will get the blocks from the server by assistantID and set the blocks array to be used to create
        // the cahtbot conversational flow
        function chatbotInit(assistantID) {
            console.log("Chatbot Init...");
            $.ajax({
                url: '../assistant/' + assistantID + '/chatbot',
                type: "GET"
            }).done(function (res) {

                console.log("Blocks retrieved successfully!");
                var data = JSON.parse(res).data;

                // Set assistant and blocks array
                assistant = data.assistant;
                blocks = data.blocks;
                welcomeMessage = assistant.message
                // Start the chatbot
                start();

            }).fail(function (res) {
                console.log("Error in retrieving blocks.");
                console.log(res);
            });
        }

        // This start the lunch the chatbot for the first time
        function start() {
            // 1.Show the chatbot welcoming message assistant.message
            if (welcomeMessage)
                newMessage(BOT_USER, toEmoticon(welcomeMessage));

            // 2.Show the first block in the blocks array then render it depends on its type
            renderBlock(blocks[0]);
        }

        // Blocks Renderer //
        function renderBlock(block) {
            currentBlock = block;
            if (currentBlock === undefined)
                return 0;

            switch (block.type) {
                case "Question":
                    renderQuestion(block);
                    break;
                case "User Input":
                    renderUserInput(block);
                    break;
                case "File Upload":
                    renderFileUpload(block);
                    break;
                case "Solutions":
                    renderSolutions(block);
                    break;
                default:
                    console.log("Block type is not recognised!!!")
            }
        }

        function renderQuestion(block) {
            $('#presetAnswers').show();
            //Show message from bot_user
            newMessage(BOT_USER, block.content.text);

            //Show answers related to question_block
            answers = block.content.answers;
            $messageInput = $("#presetAnswers").first();
            $answersDiv = $("<div class='wrap text-center' style='padding:10px;'></div>");

            for (var i = 0; i < answers.length; i++) {
                $answersDiv.append("<button class=\"answerOptions\" onclick=\"submitAnswer(this.innerText)\" >" + emojione.toImage(answers[i].text) + "</button>");
            }

            if (currentBlock.isSkippable) {
                $answersDiv.append("<button class=\"answerOptions\" onclick=\"submitAnswer(this.innerText)\" >Skip</button>");
            }

            $messageInput.html($answersDiv);

            $answersDiv.append($("<div class='row'></div>"));
        }

        function renderUserInput(block) {
            //Show message from bot_user
            newMessage(BOT_USER, block.content.text);

            //Show userinpt field
            fileUploadForm.style.display = 'none';
            chatInputDiv.style = "display:block;";
            $messageInput = $(".message-input").last();
            $userInput = $("<div class=\"wrap\" style=\"margin-top: 15px;min-height: 40px; background-color: white;\">\n" +
                "                <input autocomplete=\"off\" onkeypress=\"handleEnter(event)\" " +
                "            id='textMessage' type=\"text\" placeholder=\"Write your message...\"/>\n" +
                "                <button onclick=\"submitAnswer('')\" class=\"submit\"><i class=\"fa fa-paper-plane\" aria-hidden=\"true\"></i></button>\n" +
                "            </div>");
            $('.messages').css('height', 'calc(100% - 40px)');
            $messageInput.append($userInput);
            $("#textMessage").focus();
        }

        function skipBlock() {
            var action = undefined;
            var blockToGoId = undefined;

            if (currentBlock.type == "Question") {
                action = currentBlock.content.answers[0].action;
                blockToGoId = currentBlock.content.answers[0].blockToGoID;
            }
            else if (currentBlock.content.action) {
                action = currentBlock.content.action;
                blockToGoId = currentBlock.content.blockToGoID;
            } else {
                action = "Go To Next Block";
            }
            getNextBlock(action, blockToGoId);
        }

        function renderFileUpload(block) {
            //$messageInput = $(".message-input").first();
            //$fileUpload = $("<div class=\"wrap\">\n" +
            //    "<input onkeypress=\"handleEnter(event)\" id=\"fileUploadB\" type=\"file\" placeholder=\"Write your message...\" style=\"\n" +
            //    "    background-color:  white;\n" + "\">" +
            //    "                <button onclick=\"submitAnswer('')\" class=\"submit\"><i class=\"fa fa-paper-plane\" aria-hidden=\"true\"></i></button>\n" +
            //    "            </div>");

            //$messageInput.html($fileUpload);

            //$('.messages').css('height','calc(100% - 40px)');
            //$('.message-input').css('height','40px');

            //Show message from bot_user
            newMessage(BOT_USER, block.content.text);
            //Show file upload form
            fileUploadForm.style.display = 'block';
            chatInputDiv.style = "display:block";
        }

        function renderSolutions(block) {
            $('.messages').css('height', '100%');
            // Hide all inputs to show final solutions
            $('.message-input').hide();
            $('#presetAnswers').hide();
            chatInputDiv.style = "display:none;";
            // make request to retrive solutions
            getSolutions(block.content.showTop)
                .then((solutions) => {
                    solutions = JSON.parse(solutions);
                    displayReturnedSolutions(solutions.data.solutions)
                })
        }

        // This should send the data to the server, without returning any solutions back
        function sendData() {
            putThinkingGif();
            var solutions = [];
            params = {
                "collectedInformation": collectedInformation,
                "keywords": keywords,
                "showTop": 0,
                solutionsReturned: solutions.length
            };
            console.log("Send data...");

            return $.ajax({
                contentType: 'application/json', //this is important
                url: '../assistant/' + assistantID + '/chatbot',
                type: "POST",
                data: JSON.stringify(params)

            }).done(function (res) {
                removeThinkingGif();
                console.log("Data sent successfully!");
                var data = JSON.parse(res).data;
                sessionID = data["sessionID"];
                sendFile();
                return true;

            }).fail(function (res) {
                removeThinkingGif();
                console.log("Error in retrieving blocks.");
                console.log(res);
                return false
            });
        }


        function sendDataSolutionsBlock(showTop) {
            putThinkingGif();
            params = { "collectedInformation": collectedInformation, "keywords": keywords, "showTop": showTop };

            return $.ajax({
                contentType: 'application/json', //this is important
                url: '../assistant/' + assistantID + '/chatbot',
                type: "POST",
                data: JSON.stringify(params)

            }).done(function (res) {
                removeThinkingGif();

                console.log("Solutions retrieved successfully!");
                var data = JSON.parse(res).data;
                sessionID = data["sessionID"];
                solutions = data["solutions"];
                sendFile();
                return solutions;

            }).fail(function (res) {
                removeThinkingGif();
                console.log("Error in retrieving blocks.");
                console.log(res);
            });
        }

        function getSolutions(showTop) {
            putThinkingGif();
            params = { "keywords": keywords, "showTop": showTop };

            return $.ajax({
                contentType: 'application/json', //this is important
                url: '../assistant/' + assistantID + '/chatbot/solutions',
                type: "POST",
                data: JSON.stringify(params)

            }).done(function (res) {
                removeThinkingGif();

                console.log("Solutions retrieved successfully!");
                var data = JSON.parse(res).data;
                solutions = data["solutions"];
                return solutions;

            }).fail(function (res) {
                removeThinkingGif();
                console.log("Error in retrieving solutions.");
                console.log(res);
            });
        }

        function sendFile() {
            sendFileForm();
        }

        function sendFileForm() {
            if (document.getElementById('fileUploadB').files.length == 0) {
                return false;
            }
            var formData = new FormData();
            var fileInput = document.getElementById('fileUploadB').files[0];
            formData.append('file', fileInput, fileInput.name);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', "../assistant/" + sessionID + "/file", true);

            xhr.onload = function () {
                if (xhr.status === 200) {
                    console.log("File Sent");
                } else {
                    alert('An error occurred!');
                }
            };

            xhr.send(formData);

            return false;
        }

        function displayReturnedSolutions(solutions) {
            messageContainer = $(".messages ul");

            // If there is no solutions in the database show this message.
            if (solutions.length === 0) {
                sendAssistantMessage("Sorry, we couldn't find any solutions based on your input.")

            } else {

                for (var i = 0; i < solutions.length; i++) {
                    messageContainer.append("<li class=\"text-center\"> <center class='results'><div class='chatProducts'><h5>"
                        + emojione.toImage(solutions[i]["MajorTitle"]) + "</h5><label>" + emojione.toImage(solutions[i]["SecondaryTitle"]) + "</label><br><p>"
                        + emojione.toImage(solutions[i]["ShortDescription"]) + "</p><br><label>" + emojione.toImage(solutions[i]["Money"]) +
                        "</label><br><button onclick=\"openLink('" + emojione.toImage(solutions[i]["URL"]) +
                        "')\" class='btn btn-primary chatProducts_button' style='vertical-align:middle'><span>View </span></button></div></center></li>");
                }
            }
            // submit answer automatically
            submitAnswer('');
        }

        function openLink(link) {
            window.open(link);
        }

        // This function will render a block of type Questions with its answers to the chatbot.

        function newMessage(from, text, html = false) {
            if (from == BOT_USER) {
                if (html)
                    $('<li class="replies"><img src="/static/img/core-img/favicon-96x96.png" alt="" />' + emojione.toImage(text) + '</li>')
                    .appendTo($('.messages ul')).animate({
                      marginTop: "5px"
                    })
                else
                    $('<li class="replies"><img src="/static/img/core-img/favicon-96x96.png" alt="" /><p>' + emojione.toImage(text) + '</p></li>')
                    .appendTo($('.messages ul')).animate({
                      marginTop: "5px"
                    })
            }
            else {
                $('<li class="sent"><img src="https://cdn1.iconfinder.com/data/icons/social-messaging-productivity-1-1/128/gender-male2-512.png" alt="" /><p>' + emojione.toImage(text) + '</p></li>').appendTo($('.messages ul')).hide().fadeIn();
            }

            scrollTo('end')
        }

        async function submitAnswer(message) {

            if(currentBlock.type == "User Input"){
                if (message == "")
                    message = document.getElementById("textMessage").value;

                if (message == "" || message.replace(/ /g, "") == ""){
                    return 0;
                }
            }

            chatInputDiv.style = "display:none";
            fileUploadForm.style.display = 'none';
            // clear answers div
            $("#presetAnswers").first().html('');

            if (message.toLowerCase() === "skip" && currentBlock.isSkippable) {
                newMessage(CLIENT_USER, message.replace("&FILE_UPLOAD&", ""));
                $('#textMessage').val("");
                skipBlock();
                return 0;
            }

            if (currentBlock.type == "Solutions") {
                await sleep(200);
                putThinkingGif();
                await sleep(thinkingGifLife);
                removeThinkingGif();
                await sleep(200);

                if (currentBlock.content.afterMessage) {
                    sendAssistantMessage(currentBlock.content.afterMessage);

                    await sleep(200);
                    putThinkingGif();
                    await sleep(thinkingGifLife);
                    removeThinkingGif();
                    await sleep(200);
                }
                return getNextBlock(currentBlock.content.action, currentBlock.content.blockToGoID);
            }


            if (currentBlock.type == "File Upload") {
                //needs rework
                if ($("#displayFileName").val().toLowerCase() === "skip" && currentBlock.isSkippable) {
                    newMessage(CLIENT_USER, $("#displayFileName").val());
                    $('#displayFileName').val("");
                    skipBlock();
                    return 0;
                }
                message = "&FILE_UPLOAD&" + document.getElementById("fileUploadB").value.split("\\")[document.getElementById("fileUploadB").value.split("\\").length - 1];
                if (!checkFileFormat(message)) {
                    sendUserMessage(message.replace("&FILE_UPLOAD&", ""));

                    await sleep(200);
                    putThinkingGif();
                    await sleep(thinkingGifLife);
                    removeThinkingGif();
                    await sleep(200);

                    $('#displayFileName').val("");
                    sendAssistantMessage("That did not match the allowed file types I've been given. They are " + getAllowedFormatsString() + ".")
                    chatInputDiv.style = "display:block";
                    fileUploadForm.style.display = 'block';
                    return 0;
                }
                // clear file-upload div
                //$(".message-input").last().html('');
                //fileUploads.push(currentFileURL + ":::" + questionID + ":::" + message);

                newMessage(CLIENT_USER, message.replace("&FILE_UPLOAD&", ""));

                await sleep(200);
                putThinkingGif();
                await sleep(thinkingGifLife);
                removeThinkingGif();
                await sleep(200);

                print();

                if (currentBlock.content.afterMessage) {
                    sendAssistantMessage(currentBlock.content.afterMessage);

                    await sleep(200);
                    putThinkingGif();
                    await sleep(thinkingGifLife);
                    removeThinkingGif();
                    await sleep(200);
                }
                $('#displayFileName').val("");
                return getNextBlock(currentBlock.content.action, currentBlock.content.blockToGoID);
            }

            if (currentBlock.type == "User Input") { //validate user input

                $('#textMessage').val("");

                newMessage(CLIENT_USER, message.replace("&FILE_UPLOAD&", ""));

                print();
                addKeywords(message.replace(/ /g, " ").split(" "));

                await sleep(200);
                putThinkingGif();
                await sleep(thinkingGifLife);
                removeThinkingGif();
                await sleep(200);

                if (!validateUserInput(message, currentBlock.content.validation)) {
                    sendAssistantMessage("I am sorry but that was not in the format I think it should be...");
                    chatInputDiv.style = "display:block";
                    return 0;
                }
                else {
                    // clear user input div
                    //$(".message-input").last().html('');
                    if (currentBlock.content.afterMessage) {
                        sendAssistantMessage(currentBlock.content.afterMessage);

                        await sleep(200);
                        putThinkingGif();
                        await sleep(thinkingGifLife);
                        removeThinkingGif();
                        await sleep(200);

                    }
                }
                return getNextBlock(currentBlock.content.action, currentBlock.content.blockToGoID);
            }
            var blockKeywords = undefined
            if (currentBlock.type == "Question") {
                newMessage(CLIENT_USER, message.replace("&FILE_UPLOAD&", ""));

                await sleep(200);

                var blockAnswers = currentBlock.content.answers;

                for (var i = 0; i < blockAnswers.length; i++) {
                    if (blockAnswers[i].text == message) {
                        blockKeywords = blockAnswers[i].keywords;
                        if(blockKeywords){
                            addKeywords(blockKeywords);
                        }
                        print()
                        var action = blockAnswers[i].action;
                        var blockToGoId = blockAnswers[i].blockToGoID;

                        await sleep(200);
                        putThinkingGif();
                        await sleep(thinkingGifLife);
                        removeThinkingGif();
                        await sleep(200);

                        if (blockAnswers[i].afterMessage) {
                            sendAssistantMessage(blockAnswers[i].afterMessage);

                            await sleep(200);
                            putThinkingGif();
                            await sleep(thinkingGifLife);
                            removeThinkingGif();
                            await sleep(200);
                        }
                    }
                }
                return getNextBlock(action, blockToGoId);
            }

            function print() {
                // print the selected answer
                if (blockKeywords){
                    blockKeywords = Boolean(blockKeywords.split) ? blockKeywords.split(',') : blockKeywords;
                }

                if (currentBlock.storeInDB) {
                    var information = {
                        "blockID": currentBlock.id,
                        "questionText": currentBlock.content.text,
                        "input": message
                    };
                    if (currentBlock.type == "Question" && blockKeywords !== undefined) {
                        information["keywords"] = blockKeywords
                        collectedInformation.push(information);
                    } else {
                        information["keywords"] = []
                        collectedInformation.push(information);
                    }
                }

            }


        }

        function getNextBlock(action, blockToGoId = undefined) {
            var targetBlock = undefined;

            // Get next block based on action of the current block
            if (action === "Go To Next Block") {
                targetBlock = blocks[currentBlock.order]; //order starts from 1 and array from 0 so it just needs the current .order

            } else if (action === "Go To Specific Block") {
                for (var i = 0; i < blocks.length; i++) {
                    if (blocks[i].order === blockToGoId) {
                        targetBlock = blocks[i];
                    }
                }
            } else if (action === "End Chat") {
                sendData().then((isSuccess) => {
                    if (isSuccess) {
                        sendAssistantMessage(currentBlock.afterMessage);
                    } else {
                        sendAssistantMessage("We apologise, your input couldn't be processed. Please contact us.");
                    }
                    SetRepeat();
                });

                // End chat
                sendAssistantMessage("Thank you for completing the chatbot.");
                return 0;
            }

            // If not end chat and there is no next block
            if (targetBlock === undefined) {
                sendData().then((isSuccess) => {
                    if (isSuccess) {
                        // {#sendAssistantMessage("Thank you for your input. We'll be in touch.");#}
                    } else {
                        sendAssistantMessage("We apologise, your input couldn't be processed. Please contact us.");
                    }

                    SetRepeat();
                    return 0;
                })
            }

            // If there is next block but not same as the current block
            if (currentBlock != undefined) { //check if its not trying to reload the same block
                if (currentBlock != targetBlock) {
                    renderBlock(targetBlock);
                }
            }
        }


        function SetRepeat() {
            $("#optionsDiv").append("");
            newMessage(BOT_USER, "<div class='endChat' onclick=\"Reset()\"><a class='' style='width:400px;'>Start Again <i class=\"fa fa-refresh\" aria-hidden=\"true\"></i> </a></div>", true);
            //checkOutsideElements();
        }

        function Reset() {
            window.location.reload()
        }


        // helper functions
        function sendUserMessage(message) {

            newMessage(CLIENT_USER, toEmoticon(message));
            {#$("#messagesContainer").append("<div class='ucDiv'><li id='newMessage' class='userChat'>" + toEmoticon(message) + "</li></div>"); #}
            {#animateMessage("#newMessage"); #}
            {#document.getElementById('newMessage').id = 'oldMessage'; #}
        }

        function sendAssistantMessage(message) {
            newMessage(BOT_USER, toEmoticon(message));
            {#$("#messagesContainer").append("<div class='tsbDiv'><li id='newMessage' class='TSBbot'>" + toEmoticon(message) + "</li></div>"); #}
            {#animateMessage("#newMessage"); #}
            {#document.getElementById('newMessage').id = 'oldMessage'; #}
        }

        function putThinkingGif() {
            $(".messages ul").append('<li id="thinkingGif" class="replies"><img src="/static/img/core-img/favicon-96x96.png" alt="" /><p><img style="width:27px" id=\"thinkingGifIMG\" src="/static/images/typingDots.gif"></p></li>');
            animateMessage("#thinkingGif");
        }

        function removeThinkingGif() {
            $("#thinkingGif").remove();
        }

        function validateUserInput(message, messageType) {
            var emailRegex = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

            if (messageType == "Email" && !message.match(emailRegex)) {
                return false;
            } else if (messageType == "FullName" && name.indexOf(' ') <= 0) {
                return false;
            } else if (messageType == "Telephone" && !/^[0-9]*$/.test(message)) {
                return false;
            }

            return true;
        }

        function addKeywords(blockKeywords) {
            var addIn = true;

            for (var c = 0; c < blockKeywords.length; c++) {
                keywords.push(blockKeywords[c]);
            }
        }

        function generateUserInputThanks() {
            var thanks = "";
            switch (Math.round(Math.random() * 6)) {
                case 0:
                    thanks = "Thanks 😁";
                    break;
                case 1:
                    thanks = "Thank you 😃";
                    break;
                case 2:
                    thanks = "I'll remember that 😉";
                    break;
                case 3:
                    thanks = "Just one of the things that make you cool 😎";
                    break;
                case 4:
                    thanks = "Let me just write it down ✍️😊";
                    break;
                case 5:
                    thanks = "Give me a second to operate that information 😷";
                    break;
                case 6:
                    thanks = "Thanks 👊";
                    break;
            }
            return thanks
        }

        function checkFileFormat(message) {
            var messageSplit = message.split(".");
            var format = messageSplit[messageSplit.length - 1];
            var allowedFormats = currentBlock.content.fileTypes;
            var passes = false;
            for (var i = 0; i < allowedFormats.length; i++) {
                if (allowedFormats[i].toLowerCase() === format.toLowerCase()) {
                    passes = true;
                }
            }
            return passes;
        }

        function getAllowedFormatsString() {
            var formats = "";
            var allowedFormats = currentBlock.content.fileTypes;
            for (var i = 0; i < allowedFormats.length; i++) {
                formats += allowedFormats[i] + ", ";
            }
            formats = formats.slice(0, -2);
            return formats;
        }

        function animateMessage(id) {
            var marginAnimate = "-=25px";
            if (id == "#thinkingGif") {
                marginAnimate = "-=15px";
            }
            else if (id == "#newMessage") {
                marginAnimate = "-=35px";
            }
            $(id).animate({
                marginTop: marginAnimate
            }, "slow");
            if (!cancelScroll) {
                {#scrollTo("chatBottom"); #}
            }
        }

        function toEmoticon(message) {
            return emojione.toImage(message);
        }

        function checkOutsideElements() {
            var offScreenElements = $(':offscreen');
            for (var z = 0; z < offScreenElements.length; z++) {
                var elementID = offScreenElements[z].outerHTML.split("id=\"")[1].split("\"")[0];
                $("<br><br>").insertBefore("#" + elementID);
                checkOutsideElements();
                return 0;
            }
        }

        function scrollTo(id) {
            // {#$('html, body').stop();#}
            // {#id = "#" + id#}
            // {#$('html, body').animate({#}
            // {#    scrollTop: ($(id).offset().top)#}
            // {#}, 2000);#}

            $(".messages").animate({ scrollTop: $('.messages').prop("scrollHeight") }, "fast");

            // {#$(".messages").animate({scrollTop: $(document).height()}, "fast");#}
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function handleEnter(e) {
            var keycode = (e.keyCode ? e.keyCode : e.which);
            if (keycode == '13') {
                submitAnswer('');
            }
        }

        //compare arrays function
        // Warn if overriding existing method
        if (Array.prototype.equals)
            console.warn("Overriding existing Array.prototype.equals. Possible causes: New API defines the method, there's a framework conflict or you've got double inclusions in your code.");
        // attach the .equals method to Array's prototype to call it on any array
        Array.prototype.equals = function (array) {
            // if the other array is a falsy value, return
            if (!array)
                return false;

            // compare lengths - can save a lot of time
            if (this.length != array.length)
                return false;

            for (var i = 0, l = this.length; i < l; i++) {
                // Check if we have nested arrays
                if (this[i] instanceof Array && array[i] instanceof Array) {
                    // recurse into the nested arrays
                    if (!this[i].equals(array[i]))
                        return false;
                }
                else if (this[i] != array[i]) {
                    // Warning - two different object instances will never be equal: {x:20} != {x:20}
                    return false;
                }
            }
            return true;
        }
        // Hide method from for-in loops
        Object.defineProperty(Array.prototype, "equals", { enumerable: false });

        // Get block by id
        function getBlock(id) {
            for (var i = 0, l = blocks.length; i < l; i++) {
                if (blocks[i].id === id) {
                    return blocks[i]
                }
            }
            // If nothing found return null
            return null
        }
    </script>
    <script>
        $(document).ready(function () {
            console.log("JS is working...");
            var hrefSplit = window.location.href.split("/");
            chatbotInit(assistantID = hrefSplit[hrefSplit.length - 1]);
        });
    </script>

</body>

</html>
